# IPv6扩展头部

IPv6扩展头部是IPv6协议的一个重要特性，它提供了灵活的方式来支持可选的网络服务。每个扩展头部都由"下一个头部"字段链接。

## 扩展头部的基本格式

```
+-----------------+-----------------+----------------------+
|   下一个头部    |    头部长度     |                      |
|      8位       |      8位       |       数据区域        |
+-----------------+-----------------+----------------------+
```

## 扩展头部的处理顺序

```
┌──────────────┐
│  IPv6基本头部 │
└───────┬──────┘
        ↓
┌──────────────┐
│  逐跳选项头部 │ ◄── 必须是第一个扩展头部（如果存在）
└───────┬──────┘
        ↓
┌──────────────┐
│目的地选项头部 │ ◄── 在路由头部之前（如果存在）
└───────┬──────┘
        ↓
┌──────────────┐
│   路由头部   │
└───────┬──────┘
        ↓
┌──────────────┐
│   分片头部   │
└───────┬──────┘
        ↓
┌──────────────┐
│   认证头部   │
└───────┬──────┘
        ↓
┌──────────────┐
│ ESP安全头部  │
└───────┬──────┘
        ↓
┌──────────────┐
│目的地选项头部 │ ◄── 用于上层协议的选项
└───────┬──────┘
        ↓
┌──────────────┐
│   上层协议   │
└──────────────┘
```

## 各类扩展头部详解

### 1. 逐跳选项头部 (Hop-by-hop Options Header)
- **下一个头部值**: 0
- **用途**: 包含需要沿途每个节点处理的信息
- **特点**: 
  * 如果存在，必须紧跟在IPv6基本头部之后
  * 常用于携带路由器告警、组播参数等信息
- **格式**:
```
+-----------------+-----------------+----------------------+
|   下一个头部    |    头部长度     |      选项数据        |
|      (0)       |    (8位)       |   (变长，8位倍数)    |
+-----------------+-----------------+----------------------+
```

### 2. 目的地选项头部 (Destination Options Header)
- **下一个头部值**: 60
- **用途**: 携带仅目的节点需要处理的信息
- **特点**:
  * 可以出现在两个位置：路由头部之前或最终目的地
  * 支持家乡地址、移动IPv6等功能
- **常见选项**:
  * 家乡地址选项
  * 隧道封装限制选项
  * 移动节点标识符选项

### 3. 路由头部 (Routing Header)
- **下一个头部值**: 43
- **用途**: 指定数据包经过的一个或多个中间节点
- **类型**:
  * 类型0（已废弃）：松散源路由
  * 类型2：移动IPv6的家乡地址
  * 类型4：段路由（Segment Routing）
- **格式**:
```
+---------------+---------------+---------------+----------------+
|  下一个头部   |  头部长度    |  路由类型    |  剩余段数     |
+---------------+---------------+---------------+----------------+
|                      路由数据 (变长)                         |
+------------------------------------------------------------+
```

### 4. 分片头部 (Fragment Header)
- **下一个头部值**: 44
- **用途**: 支持大数据包的分片传输
- **特点**:
  * 仅在源节点进行分片
  * 中间路由器不进行分片
- **格式**:
```
+---------------+---------------+---------------+----------------+
|  下一个头部   |    保留      |     偏移     |  Res  |   M    |
+---------------+---------------+---------------+----------------+
|                        标识                                   |
+------------------------------------------------------------+
```
- **字段说明**:
  * 偏移：片段在原始数据包中的位置（8字节为单位）
  * M（More Fragment）：1表示后面还有分片，0表示最后一片
  * 标识：标识同一个原始数据包的所有分片

### 5. 认证头部 (Authentication Header, AH)
- **下一个头部值**: 51
- **用途**: 提供数据完整性和认证服务
- **特点**:
  * 保护整个数据包（部分IPv6头部字段除外）
  * 不提供加密服务
- **安全服务**:
  * 数据完整性验证
  * 数据源认证
  * 防重放攻击

### 6. 封装安全载荷头部 (ESP Header)
- **下一个头部值**: 50
- **用途**: 提供数据机密性保护
- **特点**:
  * 可以与AH配合使用
  * 支持多种加密算法
- **安全服务**:
  * 数据加密
  * 有限的流量分析保护
  * 可选的数据完整性服务

## 扩展头部的最佳实践

### 性能考虑
1. **处理效率**
   - 扩展头部越少越好
   - 关键业务避免使用过多扩展头部

2. **头部顺序**
   - 严格遵循推荐的处理顺序
   - 确保逐跳选项头部（如果有）位于第一位

### 安全建议
1. **分片使用**
   - 尽量避免分片
   - 使用PMTU发现确定合适的包大小

2. **IPSec使用**
   - 根据安全需求选择AH或ESP
   - 考虑性能开销

### 兼容性注意事项
1. **新旧节点兼容**
   - 考虑旧设备对新扩展头部的处理
   - 使用广泛支持的扩展头部类型

2. **头部组合**
   - 避免复杂的头部组合
   - 测试不同设备的兼容性
